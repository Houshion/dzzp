// (function () {
  var strTree = JSON.parse('{"code":1,"msg":"\u83b7\u53d6\u6210\u529f","data":[{"id":"1","name":"\u7956\u51482","pid":"0","spouses":"12","era":"1","list":"0","sex":"\u7537","education":"\u7855\u58eb","political":"\u7fa4\u4f17","head_img":"\/Upload\/img\/2017-10-18\/59e726da51dd6.jpg","era_":"\u7b2c\u4e00\u4e16","branch_era":1,"branch_era_":"\u7b2c\u4e00\u4e16","parents":[0,0],"mate":{"id":"12","name":"\u7956\u5148\u7684\u8001\u5a46","pid":"0","spouses":"0","era":"1","list":"0","sex":"\u7537","education":"\u9ad8\u4e2d","political":"\u7fa4\u4f17","head_img":"\/Upload\/img\/2017-10-18\/59e7265fc322f.jpg","era_":"\u7b2c\u4e00\u4e16"},"children":[{"id":"16","name":"\u7956\u5148\u7684\u513f\u5b503","pid":"1","spouses":"0","era":"2","list":"0","sex":"\u7537","education":"\u672c\u79d1","political":"\u515a\u5458","head_img":"\/Upload\/img\/2017-10-18\/59e7268204d1a.jpg","era_":"\u7b2c\u4e8c\u4e16","branch_era":2,"branch_era_":"\u7b2c\u4e8c\u4e16","parents":["1","12"],"mate":[],"children":[{"id":"17","name":"\u7956\u5148\u7684\u513f\u5b503\u7684\u513f\u5b501","pid":"16","spouses":"0","era":"3","list":"1","sex":"\u7537","education":"\u672c\u79d1","political":null,"head_img":"\/Upload\/img\/2017-10-18\/59e7268204d1a.jpg","era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["16",0],"mate":[],"children":[{"id":"20","name":"PDD","pid":"17","spouses":"0","era":"4","list":"123","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":null,"head_img":"\/Upload\/img\/2017-10-18\/59e726da51dd6.jpg","era_":"\u7b2c\u56db\u4e16","branch_era":4,"branch_era_":"\u7b2c\u56db\u4e16","parents":["17",0],"mate":[],"children":[]}]},{"id":"21","name":"\u5982\u679c\u6ca1\u6709\u4f60","pid":"16","spouses":"0","era":"3","list":"1","sex":"\u7537","education":"\u521d\u4e2d","political":"\u7fa4\u4f17","head_img":"\/Upload\/img\/2017-10-18\/59e7268204d1a.jpg","era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["16",0],"mate":[],"children":[]}]},{"id":"3","name":"\u7956\u5148\u7684\u513f\u5b502","pid":"1","spouses":"13","era":"2","list":"1","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":"\u7fa4\u4f17","head_img":null,"era_":"\u7b2c\u4e8c\u4e16","branch_era":2,"branch_era_":"\u7b2c\u4e8c\u4e16","parents":["1","12"],"mate":{"id":"13","name":"\u7956\u5148\u7684\u513f\u5b502\u7684\u8001\u5a46","pid":"0","spouses":"0","era":"2","list":"0","sex":"\u5973","education":"\u6682\u65e0\u5b66\u5386","political":"\u515a\u5458","head_img":null,"era_":"\u7b2c\u4e8c\u4e16"},"children":[{"id":"7","name":"\u7956\u5148\u7684\u513f\u5b502\u7684\u513f\u5b501","pid":"3","spouses":"0","era":"3","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":null,"head_img":null,"era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["3","13"],"mate":[],"children":[]},{"id":"8","name":"\u7956\u5148\u7684\u513f\u5b502\u7684\u513f\u5b502","pid":"3","spouses":"0","era":"3","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":null,"head_img":null,"era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["3","13"],"mate":[],"children":[{"id":"11","name":"\u7956\u5148\u7684\u513f\u5b502\u7684\u513f\u5b502\u7684\u513f\u5b502","pid":"8","spouses":"19","era":"4","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":"\u7fa4\u4f17","head_img":null,"era_":"\u7b2c\u56db\u4e16","branch_era":4,"branch_era_":"\u7b2c\u56db\u4e16","parents":["8",0],"mate":{"id":"19","name":"\u8001\u5a46","pid":"0","spouses":"0","era":"0","list":"0","sex":"\u7537","education":"\u521d\u4e2d","political":null,"head_img":"\/Upload\/img\/2017-10-18\/59e7268204d1a.jpg","era_":"\u7b2c\u4e16"},"children":[]}]},{"id":"9","name":"\u7956\u5148\u7684\u513f\u5b502\u7684\u513f\u5b503","pid":"3","spouses":"14","era":"3","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":null,"head_img":null,"era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["3","13"],"mate":{"id":"14","name":"\u7956\u5148\u7684\u513f\u5b502\u7684\u513f\u5b503\u7684\u8001\u5a46","pid":"0","spouses":"0","era":"3","list":"0","sex":"\u5973","education":"\u6682\u65e0\u5b66\u5386","political":"\u515a\u5458","head_img":null,"era_":"\u7b2c\u4e09\u4e16"},"children":[]}]},{"id":"2","name":"\u7956\u5148\u7684\u513f\u5b501","pid":"1","spouses":"0","era":"2","list":"2","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":"\u7fa4\u4f17","head_img":null,"era_":"\u7b2c\u4e8c\u4e16","branch_era":2,"branch_era_":"\u7b2c\u4e8c\u4e16","parents":["1","12"],"mate":[],"children":[{"id":"4","name":"\u7956\u5148\u7684\u513f\u5b501\u7684\u513f\u5b501","pid":"2","spouses":"0","era":"3","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":"\u515a\u5458","head_img":null,"era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["2",0],"mate":[],"children":[{"id":"10","name":"\u7956\u5148\u7684\u513f\u5b501\u7684\u513f\u5b501\u7684\u513f\u5b501","pid":"4","spouses":"0","era":"4","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":"\u7fa4\u4f17","head_img":null,"era_":"\u7b2c\u56db\u4e16","branch_era":4,"branch_era_":"\u7b2c\u56db\u4e16","parents":["4",0],"mate":[],"children":[]}]},{"id":"5","name":"\u7956\u5148\u7684\u513f\u5b501\u7684\u513f\u5b502","pid":"2","spouses":"0","era":"3","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":"\u515a\u5458","head_img":null,"era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["2",0],"mate":[],"children":[]},{"id":"6","name":"\u7956\u5148\u7684\u513f\u5b501\u7684\u513f\u5b503","pid":"2","spouses":"0","era":"3","list":"0","sex":"\u7537","education":"\u6682\u65e0\u5b66\u5386","political":"\u515a\u5458","head_img":null,"era_":"\u7b2c\u4e09\u4e16","branch_era":3,"branch_era_":"\u7b2c\u4e09\u4e16","parents":["2",0],"mate":[],"children":[]}]}]}]}')

  function getGenealogyList (obj) {
    var arr = []
    for (var i = 0, len = obj.length; i < len; i++) {
      arr.push(obj[i])
      arr.push(obj[i].mate)
      if (obj[i].children != null && obj[i].children.length > 0) {
        (function () {
          var _obj = arguments[0]
          for (var j = 0, _len = _obj.length; j < _len; j++) {
            arr.push(_obj[j])
            arr.push(_obj[j].mate)
            if (_obj[j].children != null && _obj[j].children.length > 0) {
              arguments.callee(_obj[j].children)
            }
          }
        })(obj[i].children)
      }
    }
    return arr
  }

  var arr = getGenealogyList(strTree.data[0].children), items = [], url = 'http://zupu.app.xiaozhuschool.com/'
  arr.unshift(strTree.data[0].mate)
  arr.unshift(strTree.data[0])

  console.log(arr);
  _.each(arr, function (item) {
    if (item.id) {
      item.templateName = 'contactTemplate2'
      if (item.mate) {
        item.spouses = new Array(item.spouses)
        items.push(new primitives.orgdiagram.ItemConfig(_.pick(item, 'spouses', 'parents', 'id', 'branch_era', 'education', 'era_', 'head_img', 'name', 'political', 'templateName')))
      } else {
        items.push(new primitives.orgdiagram.ItemConfig(_.pick(item, 'id', 'branch_era', 'education', 'era_', 'head_img', 'name', 'political', 'templateName')))
      }
    }

  })
  items.sort(function (a, b) {
    return parseInt(a.id) - parseInt(b.id)
  })

  // $(window).load(function () {

    var options = new primitives.famdiagram.Config()
    options.items = items
    options.cursorItem = 2
    options.linesWidth = 1
    options.linesColor = 'black'
    options.hasSelectorCheckbox = primitives.common.Enabled.false
    options.normalLevelShift = 20
    options.dotLevelShift = 20
    options.lineLevelShift = 20
    options.normalItemsInterval = 10
    options.dotItemsInterval = 10
    options.lineItemsInterval = 10
    options.pageFitMode = primitives.common.PageFitMode.PageHeight
    options.hasSelectorCheckbox = primitives.common.Enabled.False
    options.templates = [getContactTemplate()]
    options.onItemRender = onTemplateRender;
    options.onButtonClick = function (e, data) {
      var message = 'User clicked \'' + data.name + '\' button for item \'' + data.context.title + '\'.';
      console.log(data.context.id);
      swal({
        title: '添加族谱',
        html:
        '<select class="swal2-select" id="swal2-select">' +
        '<option value="0">第一世</option>' +
        '<option value="1">第二世</option>' +
        '<option value="2">第三世</option>' +
        '<option value="3">第四世</option>' +
        '</select>' +
        '<input id="swal-input1" class="swal2-input" placeholder="请输入父系姓名">'+
        '<input id="swal-input2" class="swal2-input" placeholder="请输入支系名称">',
        focusConfirm: false,
        preConfirm: function () {
          return new Promise(function (resolve,reject) {
            resolve([
              $('#swal2-select').val(),
              $('#swal-input1').val(),
              $('#swal-input2').val()
            ])
            reject()
          })
        }
      }).then(function (result) {
        swal(JSON.stringify(result))
      },function () {

      }).catch(swal.noop)
    }

    jQuery('#basicdiagram').famDiagram(options);

    /**
     * 自定义模板
     * @returns {primitives.orgdiagram.TemplateConfig}
     */
    function getContactTemplate () {
      var result = new primitives.orgdiagram.TemplateConfig()
      result.name = 'contactTemplate2'

      var buttons = []
      buttons.push(new primitives.orgdiagram.ButtonConfig('add', 'ui-icon-person', '添加'))
      result.buttons = buttons

      result.itemSize = new primitives.common.Size(125, 150)
      result.minimizedItemSize = new primitives.common.Size(3, 3)
      result.highlightPadding = new primitives.common.Thickness(2, 2, 2, 2)

      var itemTemplate = jQuery(
        '<div class="bp-item bp-corner-all bt-item-frame">'
        + '<div name="name" class="bp-item bp-title" style="bottom: 5px;left: 0;right: 0;text-align: center;color: #000;">'
        + '</div>'
        + '<div class="bp-item bp-photo-frame" style="height:108px; width:108px;left: 0;right: 0;top: 5px;margin: auto;">'
        + '<img name="head_img" style="height: 100%;width: 100%;"/>'
        + '</div>'
        + '</div>'
      ).css({
        width: result.itemSize.width + 'px',
        height: result.itemSize.height + 'px'
      }).addClass('bp-item bp-corner-all bt-item-frame')
      result.itemTemplate = itemTemplate.wrap('<div>').parent().html()

      return result
    }

    /**
     * 渲染模板
     * @param event
     * @param data
     */
    function onTemplateRender (event, data) {
      switch (data.renderingMode) {
        case primitives.common.RenderingMode.Create:
					/* Initialize widgets here */
          break
        case primitives.common.RenderingMode.Update:
					/* Update widgets here */
          break
      }

      var itemConfig = data.context

      if (data.templateName == 'contactTemplate2') {
        data.element.find('[name=head_img]').attr({'src': url + itemConfig.head_img, 'alt': itemConfig.title})
        data.element.find('[name=titleBackground]').css({'background': itemConfig.itemTitleColor})

        var fields = ['branch_era', 'education', 'era_', 'name', 'political', 'id']
        for (var index = 0; index < fields.length; index++) {
          var field = fields[index]

          var element = data.element.find('[name=' + field + ']')
          if (element.text() != itemConfig[field]) {
            element.text(itemConfig[field])
          }
        }
      }
    }
  // })
// })()